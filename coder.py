import argparse
import os
import re
import sys
from configs.config import Config
from configs.llm import invoke_llm, PROMPTS
from configs.git_tools import setup_git, get_repo, checkout_branch, commit_and_push, get_project_files

def parse_files(text):
    pattern = re.compile(r'<FILE path="([^"\n]+)">\n(.*?)\n</FILE>', re.DOTALL)
    files = []
    for match in pattern.finditer(text):
        files.append({"path": match.group(1), "content": match.group(2)})
    return files

def check_iteration_limit(pr_number):
    """–°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"""
    try:
        repo = get_repo()
        pr = repo.get_pull(int(pr_number))
        comments = list(pr.get_issue_comments())
        
        bot_reviews = 0
        for comment in comments:
            # –°—á–∏—Ç–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –Ω–∞—à–∏–º –º–∞—Ä–∫–µ—Ä–æ–º
            if "‚ö†Ô∏è **Review Status:**" in comment.body or "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –∑–∞–º–µ—á–∞–Ω–∏—è" in comment.body:
                bot_reviews += 1
        
        print(f"üîÑ –¢–µ–∫—É—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: {bot_reviews}/5")
        
        if bot_reviews >= 5:
            msg = "‚õî –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π (5). –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫–∞."
            pr.create_issue_comment(msg)
            print("‚ùå Limit reached. Exiting.")
            sys.exit(0) # –í—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–∫–∏ CI, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—Ç—É
            
    except Exception as e:
        print(f"Warning: Could not check iteration limit: {e}")

def run_coder():
    parser = argparse.ArgumentParser()
    parser.add_argument("--issue", help="Issue number")
    parser.add_argument("--pr", help="PR number (fix mode)")
    parser.add_argument("--fix", action="store_true")
    args = parser.parse_args()

    Config.validate()
    setup_git()
    repo = get_repo()

    # --- –†–ï–ñ–ò–ú 1: New Feature ---
    if args.issue and not args.fix:
        issue = repo.get_issue(int(args.issue))
        print(f"üöÄ –ó–∞–¥–∞—á–∞: {issue.title}")
        branch_name = f"feature/issue-{args.issue}"
        checkout_branch(branch_name, create_new=True)
        
        system_prompt = PROMPTS["coder_new"]
        user_prompt = f"TITLE: {issue.title}\nBODY: {issue.body}"
        
        # –î–ª—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ PR —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ, issue –∑–¥–µ—Å—å
        pr_obj = None 

    # --- –†–ï–ñ–ò–ú 2: Fix (Loop) ---
    elif args.pr and args.fix:
        print(f"üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PR #{args.pr}")
        check_iteration_limit(args.pr) # <-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
        
        pr_obj = repo.get_pull(int(args.pr))
        branch_name = pr_obj.head.ref
        checkout_branch(branch_name)
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏
        comments = list(pr_obj.get_issue_comments())
        last_feedback = comments[-1].body if comments else "General fix required."
        
        current_code = get_project_files()
        system_prompt = PROMPTS["coder_fix"]
        user_prompt = f"CODE:\n{current_code}\n\nFEEDBACK:\n{last_feedback}"
    
    else:
        print("–ù–µ–≤–µ—Ä–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã")
        return

    # --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò –ó–ê–ü–ò–°–¨ ---
    print("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞...")
    response = invoke_llm(system_prompt, user_prompt)
    files = parse_files(response)

    if not files:
        print("‚ö†Ô∏è –ö–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
        return

    for f in files:
        path = f["path"]
        if path in ["coder.py", "reviewer.py", "configs/llm.py"]: continue # –ó–∞—â–∏—Ç–∞
        
        try:
            os.makedirs(os.path.dirname(path) or ".", exist_ok=True)
            with open(path, "w", encoding="utf-8") as file:
                file.write(f["content"])
            print(f"üìù –ó–∞–ø–∏—Å–∞–Ω: {path}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ {path}: {e}")

    # --- –ü–£–® ---
    msg = "AI Fixes based on review" if args.fix else f"AI Feature: {issue.title}"
    if commit_and_push(branch_name, msg):
        print("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã")
        
        # –°–æ–∑–¥–∞–µ–º PR —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (–Ω–µ —Ñ–∏–∫—Å)
        if args.issue and not args.fix:
            try:
                pr = repo.create_pull(
                    title=f"Resolve: {issue.title}",
                    body="Generated by AI Code Agent",
                    head=branch_name,
                    base="main"
                )
                print(f"üîó PR —Å–æ–∑–¥–∞–Ω: {pr.html_url}")
            except Exception as e:
                print(f"Info: {e}")

if __name__ == "__main__":
    run_coder()