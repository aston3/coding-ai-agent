# coder.py
import argparse
import os
import re
from config import Config
from llm import invoke_llm, PROMPTS
from git_tools import setup_git, get_repo, checkout_branch, commit_and_push, get_project_files

def parse_files(text):
    """–ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç LLM –Ω–∞ —Ñ–∞–π–ª—ã"""
    pattern = re.compile(r'<FILE path="(.*?)">\n(.*?)\n</FILE>', re.DOTALL)
    return [{"path": p, "content": c} for p, c in pattern.findall(text)]

def run_coder():
    parser = argparse.ArgumentParser()
    parser.add_argument("--issue", help="Issue number")
    parser.add_argument("--pr", help="PR number (fix mode)")
    parser.add_argument("--fix", action="store_true")
    args = parser.parse_args()

    Config.validate()
    setup_git()
    repo = get_repo()

    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–∞—è —Ñ–∏—á–∞ (Issue)
    if args.issue and not args.fix:
        issue = repo.get_issue(int(args.issue))
        print(f"üöÄ –ó–∞–¥–∞—á–∞: {issue.title}")
        
        branch_name = f"feature/issue-{args.issue}"
        checkout_branch(branch_name, create_new=True) # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç - —É–ø–∞–¥–µ–º –≤ checkout

        system_prompt = PROMPTS["coder_new"]
        user_prompt = f"TITLE: {issue.title}\nBODY: {issue.body}"

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (PR + Review)
    elif args.pr and args.fix:
        pr = repo.get_pull(int(args.pr))
        print(f"üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PR #{args.pr}")
        
        branch_name = pr.head.ref
        checkout_branch(branch_name) # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–µ—Ç–∫—É PR
        
        comments = list(pr.get_issue_comments())
        last_feedback = comments[-1].body if comments else "Fix logic errors."
        
        current_code = get_project_files() # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–¥
        
        system_prompt = PROMPTS["coder_fix"]
        user_prompt = f"CODE:\n{current_code}\n\nFEEDBACK:\n{last_feedback}"

    # –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
    print("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞...")
    response = invoke_llm(system_prompt, user_prompt)
    files = parse_files(response)

    if not files:
        print("‚ö†Ô∏è –ö–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
        return

    # –ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤
    for f in files:
        path = f["path"]
        os.makedirs(os.path.dirname(path) or ".", exist_ok=True)
        with open(path, "w", encoding="utf-8") as file:
            file.write(f["content"])
        print(f"üìù –ó–∞–ø–∏—Å–∞–Ω: {path}")

    # –ü—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π
    msg = f"AI Update: {issue.title if args.issue else 'Fixes'}"
    if commit_and_push(branch_name, msg):
        print("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã")
        # –°–æ–∑–¥–∞–Ω–∏–µ PR —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞
        if args.issue and not args.fix:
            try:
                pr = repo.create_pull(
                    title=f"Resolve: {issue.title}",
                    body="Generated by AI Code Agent",
                    head=branch_name,
                    base="main"
                )
                print(f"üîó PR —Å–æ–∑–¥–∞–Ω: {pr.html_url}")
            except Exception as e:
                print(f"PR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    run_coder()